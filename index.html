<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duty Tracker Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050505">

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Razorpay & PayPal SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AfOzNhmiQjamiR4usKOUs_hullqnPZaXSTks076L48mXJJaMAn3Rblux_KJsP6_D20xX3s37hnns4p2R&currency=USD"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #6C63FF; --secondary: #00F0FF; --accent: #FF0055;
            --dark-bg: #050505; --surface: #121212; --glass: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.15); --gradient: linear-gradient(135deg, #6C63FF, #00F0FF);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--dark-bg); background-image: radial-gradient(circle at 50% 50%, rgba(108, 99, 255, 0.12) 0%, transparent 60%); color: #ffffff; overflow-x: hidden; min-height: 100vh; display: flex; flex-direction: column; }

        /* --- 1. FIXED SPLASH SCREEN (PERFECT CENTER) --- */
        #splash { 
            position: fixed; inset: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            z-index: 9999999; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center;
            transition: opacity 0.8s ease-out;
        }
        .splash-content { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .splash-logo-icon { font-size: 100px !important; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px; animation: pulse 2s infinite; filter: drop-shadow(0 0 15px rgba(108, 99, 255, 0.6)); }
        .splash-title { font-size: 32px; font-weight: 800; color: white; margin-bottom: 30px; }
        .loader { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top-color: var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        .splash-footer { position: absolute; bottom: 30px; text-align: center; width: 100%; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); } }

        /* --- 2. AUTH SCREEN --- */
        #auth-screen { position: fixed; inset: 0; width: 100%; height: 100%; background-color: var(--dark-bg); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .auth-box { background: var(--glass); padding: 40px 30px; max-width: 380px; width: 100%; border-radius: 24px; text-align: center; border: 1px solid var(--border); box-shadow: 0 0 40px rgba(108, 99, 255, 0.2); }
        .auth-inp { width: 100%; padding: 16px; margin: 0; border-radius: 12px; border: 1px solid #333; background: #000; color: white; text-align: center; font-size: 18px; outline: none; margin-bottom: 20px; }
        .action-btn { width: 100%; padding: 16px; border-radius: 12px; border: none; background: var(--gradient); color: white; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; margin-top: 10px; }

        /* --- 3. MAIN UI --- */
        #main-app { display: none; flex-direction: column; flex: 1; position: relative; }
        nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 18px; font-weight: 800; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #pwa-install-btn { background: var(--gradient); border: none; color: white; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; cursor: pointer; display: none; }

        /* PAYMENT SCREEN (FIXED YEARLY) */
        #payment-screen { position: fixed; inset: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); backdrop-filter: blur(25px); z-index: 99999; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .lock-card { background: #111; padding: 25px; border-radius: 24px; border: 1px solid var(--accent); max-width: 400px; width: 100%; box-shadow: 0 0 50px rgba(255, 0, 85, 0.3); }
        .plan-box { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 16px; padding: 15px; margin-bottom: 15px; text-align: left; }
        .plan-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .pay-btn-rzp { width: 100%; padding: 12px; background: #3399cc; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .paypal-container { width: 100%; margin-top: 10px; min-height: 45px; position: relative; z-index: 10; clear: both; display: flex; justify-content: center; }

        /* CALENDAR */
        .app-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        #calendar-grid { padding: 10px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 100px; }
        .day-cell { height: 85px; background: rgba(255,255,255,0.05); border-radius: 14px; border: 1px solid transparent; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        
        .bg-Present { background: #4caf50 !important; color: white; }
        .bg-Leave { background: #f44336 !important; color: white; }
        .bg-Sick { background: #ff9800 !important; color: white; }
        .bg-Holiday { background: #9c27b0 !important; color: white; }
        .bg-Off { background: #607d8b !important; color: white; opacity: 0.7; }

        /* PAGES */
        .full-page { position: fixed; inset: 0; width: 100%; height: 100%; background: var(--dark-bg); z-index: 3000; display: none; flex-direction: column; overflow-y: auto; }
        .fp-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.8); }
        .fp-body { padding: 20px; padding-bottom: 150px; }
        .profile-card { background: linear-gradient(135deg, #381E72, #0D0D12); padding: 25px; border-radius: 28px; border: 1px solid var(--border); margin-bottom: 25px; text-align: center; }
        .sub-badge { background: var(--accent); color: white; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }

        /* DONATE */
        #donate-box { background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 25px; margin: 25px 0; border: 1px solid var(--secondary); text-align: center; display: none; }
        .donate-badges { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 20px; }
        .donate-badges img { height: 42px; border-radius: 8px; cursor: pointer; }

        .legal-btn { width: 100%; padding: 15px; text-align: left; background: rgba(255,255,255,0.05); border: 1px solid var(--border); margin-bottom: 10px; color: #ccc; border-radius: 12px; display: flex; justify-content: space-between; cursor: pointer; }

        #modal { position: fixed; bottom: 0; width: 100%; background: #111; padding: 25px; border-radius: 30px 30px 0 0; display: none; z-index: 2000; border-top: 1px solid var(--border); }
        .type-btn { padding: 12px; margin: 5px; background: #222; color: white; border: 1px solid #333; border-radius: 8px; width: 30%; font-weight: bold; }
        .type-btn.active { border-color: var(--secondary); background: rgba(0, 240, 255, 0.1); }
        
        .bottom-bar { position: fixed; bottom: 20px; left: 0; width: 100%; display: flex; justify-content: center; gap: 15px; z-index: 500; }
        .bar-btn { padding: 12px 25px; border-radius: 50px; border: 1px solid var(--border); background: rgba(255,255,255,0.1); color: white; font-weight: bold; backdrop-filter: blur(10px); }

        #legal-modal { position: fixed; inset: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 4000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .legal-content { background: #151515; width: 100%; max-width: 500px; border-radius: 20px; border: 1px solid var(--border); max-height: 80vh; overflow-y: auto; padding: 25px; position: relative; color: #ccc; line-height: 1.6; }
    </style>
</head>
<body>

    <!-- SPLASH SCREEN -->
    <div id="splash">
        <div class="splash-content">
            <span class="material-icons splash-logo-icon">assignment_ind</span>
            <div class="splash-title">Duty Tracker Pro</div>
            <div class="loader"></div>
        </div>
        <div class="splash-footer">
            <div style="font-size:14px; color:#ccc;">Developer By <b>Nitai Studio</b></div>
            <div class="made-in">Made in India <img src="https://flagcdn.com/w40/in.png" alt="India Flag"></div>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-box">
            <i class="fas fa-fingerprint" style="font-size:50px; color:var(--primary); margin-bottom:20px;"></i>
            <h2>Sign In</h2>
            <p style="color:#aaa; font-size:12px; margin-bottom:25px;">Enter Mobile Number for Sync & Trial</p>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <select id="country-code" style="padding:15px; border-radius:12px; background:#000; color:white; border:1px solid #333; width:100px; outline:none;">
                    <option value="+91">üáÆüá≥ +91</option><option value="+880">üáßüá© +880</option><option value="+1">üá∫üá∏ +1</option><option value="+44">üá¨üáß +44</option>
                    <script>
                        const cArr = [["UAE","+971"],["Saudi","+966"],["Australia","+61"],["Canada","+1"],["Germany","+49"],["France","+33"],["Japan","+81"],["Russia","+7"],["Nepal","+977"]];
                        cArr.forEach(c => document.write(`<option value="${c[1]}">${c[0]} (${c[1]})</option>`));
                    </script>
                </select>
                <input type="number" id="auth-phone" class="auth-inp" placeholder="Mobile Number" style="margin:0; flex:1;">
            </div>
            <button class="action-btn" onclick="app.login()">Get Started</button>
        </div>
    </div>

    <!-- PAYMENT SCREEN -->
    <div id="payment-screen">
        <div class="lock-card">
            <h2 style="margin-bottom:10px; text-align:center; color:white;">Premium Access</h2>
            <p style="color:#aaa; font-size:13px; margin-bottom:25px; text-align:center;">Trial period ended. Renew subscription.</p>
            <div class="plan-box">
                <div class="plan-header"><b>Monthly</b> <span>‚Çπ5 / $0.10</span></div>
                <button class="pay-btn-rzp" onclick="pay.razorpay(5, 'monthly')">Razorpay (India)</button>
                <div id="pp-monthly" class="paypal-container"></div>
            </div>
            <div class="plan-box">
                <div class="plan-header"><b>Yearly</b> <span>‚Çπ40 / $0.50</span></div>
                <button class="pay-btn-rzp" onclick="pay.razorpay(40, 'yearly')">Razorpay (India)</button>
                <div id="pp-yearly" class="paypal-container"></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app">
        <nav><div class="logo">Duty Tracker Pro</div><button id="pwa-install-btn" onclick="pwa.install()">INSTALL</button></nav>
        <div class="app-header">
            <button onclick="cal.move(-1)" style="background:none; border:none; color:white;"><i class="fas fa-chevron-left" style="font-size:24px;"></i></button>
            <h3 id="month-txt">...</h3>
            <button onclick="cal.move(1)" style="background:none; border:none; color:white;"><i class="fas fa-chevron-right" style="font-size:24px;"></i></button>
        </div>
        <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:12px; font-weight:bold; margin-bottom:10px; color:#aaa; padding:0 15px;"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div>
        <div id="calendar-grid"></div>
        <div class="bottom-bar">
            <button onclick="reports.open()" class="bar-btn">Reports</button>
            <button onclick="ui.openProfile()" class="bar-btn">Profile</button>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal">
        <h3 id="modal-date" style="text-align:center; margin-bottom:20px; color:white;">Date</h3>
        <div class="type-grid">
            <button class="type-btn" onclick="data.set('Present', this)">Present</button>
            <button class="type-btn" onclick="data.set('Leave', this)">Leave</button>
            <button class="type-btn" onclick="data.set('Sick', this)">Sick</button>
            <button class="type-btn" onclick="data.set('Holiday', this)">Holiday</button>
            <button class="type-btn" onclick="data.set('Off', this)">Off</button>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="number" id="inp-ot" placeholder="OT Hrs" class="auth-inp" style="width:50%; margin:0; border-radius:10px;">
            <input type="number" id="inp-late" placeholder="Late Min" class="auth-inp" style="width:50%; margin:0; border-radius:10px;">
        </div>
        <button class="action-btn" onclick="data.save()">Save Entry</button>
        <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; color:red; background:none; border:none; margin-top:10px;">Cancel</button>
    </div>

    <!-- SETTINGS -->
    <div id="settings" class="full-page">
        <div class="fp-head"><i class="fas fa-arrow-left" onclick="this.parentElement.parentElement.style.display='none'"></i> <h3>Profile & Settings</h3></div>
        <div class="fp-body">
            <div class="profile-card">
                <i class="fas fa-user-circle" style="font-size:60px; color:var(--primary); margin-bottom:10px;"></i>
                <h3 id="prof-id">...</h3>
                <div style="margin:10px 0;"><span class="sub-badge" id="prof-status">TRIAL</span></div>
                <p id="prof-exp" style="font-size:12px; color:#aaa;"></p>
                <button class="action-btn" id="extend-btn" style="background:var(--accent); font-size:14px; display:none;" onclick="pay.showPaymentScreen(false)">‚ö° Renew Subscription</button>
            </div>

            <div id="donate-box">
                <h4 style="color:white; margin:20px 0 10px; text-align:center;">Support Development ‚ù§Ô∏è</h4>
                <div class="donate-badges">
                    <a href="https://buymeacoffee.com/nitaigrp00a" target="_blank"><img src="https://img.shields.io/badge/Buy_Me_a_Coffee-FFDD00?logo=buy-me-a-coffee&logoColor=black&style=for-the-badge"></a>
                    <a href="https://ko-fi.com/nitaisarkar" target="_blank"><img src="https://img.shields.io/badge/Ko--fi-Support%20Me-FF5E5B?logo=ko-fi&logoColor=white&style=for-the-badge"></a>
                </div>
            </div>

            <h4 style="color:var(--primary); margin-bottom:15px;">Salary Configuration</h4>
            <div class="m3-card">
                <label>Currency</label><select id="set-cur" class="auth-inp" style="margin-bottom:15px;"><option value="‡ß≥">‡ß≥ (BDT)</option><option value="‚Çπ">‚Çπ (INR)</option><option value="$">$ (USD)</option></select>
                <label>Daily Wage</label><input type="number" id="set-sal" class="auth-inp" placeholder="Salary">
                <label>OT Rate (Hour)</label><input type="number" id="set-otr" class="auth-inp" placeholder="OT Rate">
                <button class="action-btn" onclick="settings.save()">Save Configuration</button>
            </div>
            
            <button class="legal-btn" onclick="window.open('https://nitaistudio.github.io/DutyTrackerPro/policies.html')">Legal Policies <i class="fas fa-chevron-right"></i></button>
            <button class="action-btn" style="background:#222; border:1px solid #333; margin-top:20px;" onclick="localStorage.clear(); location.reload();">Logout Account</button>
        </div>
    </div>

    <!-- REPORTS -->
    <div id="reports" class="full-page">
        <div class="fp-head"><i class="fas fa-arrow-left" onclick="this.parentElement.parentElement.style.display='none'"></i> <h3>Work Reports</h3></div>
        <div class="fp-body">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="date" id="r-start" class="auth-inp" style="margin:0;">
                <input type="date" id="r-end" class="auth-inp" style="margin:0;">
            </div>
            <button class="action-btn" onclick="reports.calc()">Generate</button>
            <div id="r-out" style="margin-top:25px;"></div>
        </div>
    </div>

    <script>
        // DOMAIN LOCK
        (function() {
            var allowed = "nitaistudio.github.io"; 
            if (window.location.hostname && window.location.hostname !== allowed && window.location.hostname !== "localhost" && window.location.hostname !== "127.0.0.1") {
                document.body.innerHTML = "<h1>Access Denied</h1>"; throw new Error("Locked");
            }
        })();

        // CONFIG (NEW FIREBASE)
        const firebaseConfig = {
            apiKey: "AIzaSyDxqq2PBqrtkTsygyMcIDOvZyx2_-x4QRk",
            authDomain: "duty-tracker-pro.firebaseapp.com",
            databaseURL: "https://duty-tracker-pro-default-rtdb.firebaseio.com",
            projectId: "duty-tracker-pro",
            storageBucket: "duty-tracker-pro.firebasestorage.app",
            messagingSenderId: "716525293622",
            appId: "1:716525293622:web:880f39084c86180fbb0897"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const RZP_KEY = "rzp_live_Rz7kQ4RAloCWGp";

        const s = { uid: null, country: null, date: new Date(), data: {}, sub: 0, conf: { cur: '‡ß≥', sal: 0, otr: 0 } };
        let sel = { d: null, t: null };
        let paypalRendered = false;
        let deferredPrompt;

        // PWA INSTALL
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('pwa-install-btn').style.display='block'; });
        const pwa = { install: () => { if(deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then(()=>deferredPrompt=null); } } };

        // BOOT
        window.onload = () => {
            const id = localStorage.getItem('dt_id');
            const country = localStorage.getItem('dt_country');
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash').style.display = 'none';
                    if(id && country) { s.country = country; app.start(id); }
                    else document.getElementById('auth-screen').style.display = 'flex';
                }, 800);
            }, 3000);
        };

        const app = {
            login: () => {
                const code = document.getElementById('country-code').value;
                const num = document.getElementById('auth-phone').value.trim();
                if(num.length > 5) {
                    const fullId = code + num; s.country = code;
                    localStorage.setItem('dt_id', fullId); localStorage.setItem('dt_country', code);
                    document.getElementById('auth-screen').style.display = 'none';
                    app.start(fullId);
                }
            },
            start: (id) => { 
                s.uid = id;
                document.getElementById('main-app').style.display = 'flex';
                db.ref('u/' + s.uid).on('value', snap => {
                    const v = snap.val() || {};
                    s.data = v.att || {};
                    const isIndia = (s.country === '+91');

                    if (isIndia) {
                        if (!v.subExp) {
                            const trialEnd = Date.now() + (3 * 24 * 60 * 60 * 1000); // 3 Day Trial
                            db.ref('u/' + s.uid + '/subExp').set(trialEnd);
                            s.sub = trialEnd;
                        } else s.sub = v.subExp;
                        document.getElementById('extend-btn').style.display = 'block';
                        document.getElementById('donate-box').style.display = 'none';
                        if(Date.now() > s.sub) pay.showPaymentScreen(true);
                    } else {
                        document.getElementById('extend-btn').style.display = 'none';
                        document.getElementById('donate-box').style.display = 'block';
                        s.sub = Date.now() + 999999999999;
                    }
                    if(v.conf) {
                        s.conf = { ...s.conf, ...v.conf };
                        document.getElementById('set-cur').value = s.conf.cur || '‡ß≥';
                        document.getElementById('set-sal').value = s.conf.sal || '';
                        document.getElementById('set-otr').value = s.conf.otr || '';
                    }
                    cal.render();
                });
            }
        };

        const pay = {
            showPaymentScreen: (locked) => {
                document.getElementById('payment-screen').style.display = 'flex';
                if(!paypalRendered) {
                    paypalRendered = true;
                    setTimeout(() => {
                        paypal.Buttons({ style: { layout: 'horizontal', color: 'gold' }, createOrder: (d, a) => a.order.create({ purchase_units: [{ amount: { value: '0.10' } }] }), onApprove: () => pay.success(30) }).render('#pp-monthly');
                    }, 500);
                }
            },
            razorpay: (amt, plan) => {
                const opt = { "key": RZP_KEY, "amount": amt * 100, "currency": "INR", "name": "Duty Tracker Pro", "handler": () => {
                    const add = (plan === 'yearly') ? 31536000000 : 2592000000;
                    db.ref('u/' + s.uid + '/subExp').set(Date.now() + add).then(() => location.reload());
                }};
                new Razorpay(opt).open();
            },
            success: (days) => {
                const add = days * 24 * 60 * 60 * 1000;
                db.ref('u/' + s.uid + '/subExp').set(Date.now() + add).then(() => location.reload());
            }
        };

        const cal = {
            getIso: (y, m, d) => `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`,
            render: () => {
                const y=s.date.getFullYear(), m=s.date.getMonth();
                const mN = ["January","February","March","April","May","June","July","August","September","October","November","December"];
                document.getElementById('month-txt').innerText = `${mN[m]} ${y}`;
                const grid = document.getElementById('calendar-grid'); grid.innerHTML='';
                const fDay = new Date(y,m,1).getDay(), lDate = new Date(y,m+1,0).getDate();
                for(let i=0; i<fDay; i++) grid.innerHTML += `<div></div>`;
                for(let i=1; i<=lDate; i++) {
                    const iso = cal.getIso(y, m, i);
                    const ent = s.data[iso];
                    const el = document.createElement('div'); el.className = 'day-cell ' + (ent ? 'bg-'+ent.t : '');
                    if(iso === new Date().toISOString().split('T')[0]) el.style.border = '2px solid var(--secondary)';
                    el.innerHTML = `<span class="day-num">${i}</span>`;
                    if(ent) {
                        el.innerHTML += `<div style="font-size:9px; margin-top:3px; opacity:0.8; font-weight:bold;">${ent.t}</div>`;
                        if(ent.ot > 0) el.innerHTML += `<div style="font-size:9px; color:#ffff00; font-weight:bold;">OT:${ent.ot}</div>`;
                    }
                    el.onclick=()=> {
                        sel.d = iso; document.getElementById('modal-date').innerText = new Date(iso).toDateString();
                        document.getElementById('modal').style.display='block';
                        if(ent) { document.getElementById('inp-ot').value = ent.ot || ''; document.getElementById('inp-late').value = ent.lt || ''; }
                    };
                    grid.appendChild(el);
                }
            },
            move: (v) => { s.date.setMonth(s.date.getMonth()+v); cal.render(); }
        };

        const data = {
            set: (t, b) => { sel.t = t; document.querySelectorAll('.type-btn').forEach(btn=>btn.classList.remove('active')); b.classList.add('active'); },
            save: () => {
                const p = { t: sel.t || 'Present', ot: document.getElementById('inp-ot').value, lt: document.getElementById('inp-late').value };
                db.ref(`u/${s.uid}/att/${sel.d}`).set(p).then(() => { s.data[sel.d] = p; cal.render(); document.getElementById('modal').style.display='none'; });
            }
        };

        const settings = {
            save: () => {
                s.conf.cur = document.getElementById('set-cur').value;
                s.conf.sal = parseFloat(document.getElementById('set-sal').value) || 0;
                s.conf.otr = parseFloat(document.getElementById('set-otr').value) || 0;
                db.ref(`u/${s.uid}/conf`).set(s.conf).then(()=>alert("Configuration Saved!"));
            }
        };

        const ui = {
            showHome: () => { document.querySelectorAll('.full-page').forEach(p=>p.style.display='none'); },
            openProfile: () => {
                document.getElementById('settings').style.display = 'flex';
                document.getElementById('prof-id').innerText = s.uid;
                const days = Math.ceil((s.sub - Date.now()) / 86400000);
                if(s.country === '+91') {
                    document.getElementById('prof-status').innerText = days > 0 ? days + " DAYS LEFT" : "EXPIRED";
                    document.getElementById('prof-exp').innerText = "Premium valid till: " + new Date(s.sub).toDateString();
                } else {
                    document.getElementById('prof-status').innerText = "LIFETIME FREE";
                    document.getElementById('prof-exp').innerText = "Global Access Active";
                }
            }
        };

        const reports = {
            open: () => { document.getElementById('reports').style.display='flex'; },
            calc: () => {
                const start = new Date(document.getElementById('r-start').value);
                const end = new Date(document.getElementById('r-end').value);
                if(!start || !end) return alert("Select Dates First");
                let pres=0, otHrs=0, tot=0, hol=0, sick=0;
                for(let k in s.data) {
                    const d = new Date(k);
                    if(d >= start && d <= end) {
                        const type = s.data[k].t;
                        if(type === 'Present') pres++; if(type === 'Holiday') hol++; if(type === 'Sick') sick++;
                        otHrs += parseFloat(s.data[k].ot||0); tot++;
                    }
                }
                const earn = ((pres + hol + sick) * s.conf.sal) + (otHrs * s.conf.otr);
                document.getElementById('r-out').innerHTML = `<div class="profile-card" style="text-align:left;"><p>Entries: <b>${tot}</b></p><p>Paid Days: <b>${pres+hol+sick}</b></p><p>OT Hours: <b>${otHrs}</b></p><hr style="margin:10px 0;"><h3 style="color:var(--secondary)">Total Income: ${s.conf.cur} ${earn}</h3><button onclick="document.getElementById('reports').style.display='none'" class="action-btn" style="margin-top:20px;">Close Report</button></div>`;
            }
        };

        const legal = {
            show: (type) => {
                const t = { 'privacy': 'Privacy Policy', 'refund': 'Refund Policy' };
                const b = {
                    'privacy': 'Duty Tracker Pro values your privacy. We collect your mobile number solely for account identification and synchronization. Your work records and salary configurations are stored securely on Google Firebase. We never share your data with third parties.',
                    'refund': 'All premium subscriptions are digital services and activated instantly. Therefore, we generally do not offer refunds. If a payment fails to unlock your account, contact nitai.grp00@gmail.com.'
                };
                document.getElementById('legal-title').innerText = t[type];
                document.getElementById('legal-body').innerText = b[type];
                document.getElementById('legal-modal').style.display = 'flex';
            }
        };

        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>